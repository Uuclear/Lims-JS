


<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
	委托综合查询详情
</title><link href="../../Common/tree/css/bootstrap.min.css" rel="stylesheet" /><link href="../../Common/tree/css/style.css" rel="stylesheet" />
    <style>
        form { margin: 0; }

        .tree { width: 350px; background: none; border: 0; box-shadow: none; }

        .tittle { background: #fff; padding: 10px 5px; }

        .wrap { position: relative; /*margin-left: 358px;*/ padding: 30px; background: #444; border-left: 2px solid #ddd; z-index: 2; float: left; width: 74%; }

        .btnN { color: #fff; background-color: #337ab7; border-color: #2e6da4; display: inline-block; margin-bottom: 0; font-weight: normal; text-align: center; vertical-align: middle; -ms-touch-action: manipulation; touch-action: manipulation; cursor: pointer; background-image: none; border: 1px solid transparent; white-space: nowrap; padding: 6px 12px; font-size: 14px; line-height: 1.428571429; border-radius: 4px; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        .one { width: 98%; }
        .two { width: 74%; }
    </style>
    <script src="../../Common/tree/js/jquery-1.7.2.min.js"></script>
    <script src="../../Common/JS/jquery.js"></script>
    <script src="../../Common/JS/layer.js"></script>
    <script src="../../Common/JS/handle.js"></script>
    <script src="../../Common/JS/bootstrap-progressbar/bootstrap-progressbar.js"></script>
    <script src="../../Common/JS/bootstrap-progressbar/bootstrap-progressbar.min.js"></script>
    <link href="../../Common/Css/bootstrap/bootstrap.min.css" rel="stylesheet" /></head>
<body>
    <form>
        
        <input type="hidden" id="hdtestingOrderNo" value="GC18-250118" />
        <input type="hidden" id="hdtestingOrderId" value="1006181" />

        <input type="hidden" id="hdSrc" />
        <div style="float: left; height: 100%; width: 24%" id="menuLeft">
            <div class="tree well">
                <ul>
                    <li>
                        <span><i class="icon-folder-open"></i>委托编号--GC18-250118</span>
                        <ul>
                            <li>
                                <span><i class="icon-minus-sign"></i><a style="cursor: pointer; text-decoration: none;" onclick="ShowOrder('1006181')">委托信息（GC18-250118 已提交）</a></span>
                            </li>
                            
                            <li>
                                <span><i class="icon-minus-sign"></i><a style="cursor: pointer; text-decoration: none;" onclick="ShowReport('../../FileUpload/TestingOrderHtml/1006181-20250323030828.html')">原始委托信息</a></span>
                            </li>

                            
                            <li id="GcJyLi">
                                <span><i class="icon-minus-sign"></i>样品</span>
                                <ul>
                                    
                                    <li>
                                        
                                        
                                        
                                        <a onclick="ShowSamples('1505569')" style="cursor: pointer; text-decoration: none;"><span><i class="icon-leaf"></i>GC18-250118-01</span></a>
                                        
                                    </li>
                                    
                                    <li>
                                        
                                        
                                        
                                        <a onclick="ShowSamples('1505870')" style="cursor: pointer; text-decoration: none;"><span><i class="icon-leaf"></i>GC18-250118-02</span></a>
                                        
                                    </li>
                                    
                                    <li>
                                        
                                        
                                        
                                        <a onclick="ShowSamples('1505871')" style="cursor: pointer; text-decoration: none;"><span><i class="icon-leaf"></i>GC18-250118-03</span></a>
                                        
                                    </li>
                                    
                                    <li>
                                        
                                        
                                        
                                        <a onclick="ShowSamples('1505872')" style="cursor: pointer; text-decoration: none;"><span><i class="icon-leaf"></i>GC18-250118-04</span></a>
                                        
                                    </li>
                                    
                                    <li>
                                        
                                        
                                        
                                        <a onclick="ShowSamples('1505873')" style="cursor: pointer; text-decoration: none;"><span><i class="icon-leaf"></i>GC18-250118-05</span></a>
                                        
                                    </li>
                                    
                                    <li>
                                        
                                        
                                        
                                        <a onclick="ShowSamples('1505874')" style="cursor: pointer; text-decoration: none;"><span><i class="icon-leaf"></i>GC18-250118-06</span></a>
                                        
                                    </li>
                                    
                                </ul>
                            </li>
                            <li>
                                <span><i class="icon-minus-sign"></i><a style="cursor: pointer; text-decoration: none;" onclick="hrefView()">任务</a></span>
                            </li>
                            <li>
                                <span><i class="icon-minus-sign"></i>报告</span>
                                <ul>
                                    
                                    <li>
                                        <a onclick="ShowReport('/FileUpload/report/PDF/2285849.pdf?1399',this)" style="cursor: pointer; text-decoration: none;" data-id="2285849" data-sampleid="1505569" data-value="GC188-250152">
                                            <span>
                                                <i class="icon-leaf"></i>GC188-250152(待批准)
                                            </span></a>
                                    </li>
                                    
                                    <li>
                                        <a onclick="ShowReport('/FileUpload/report/PDF/2285851.pdf?1399',this)" style="cursor: pointer; text-decoration: none;" data-id="2285851" data-sampleid="1505870" data-value="GC188-250153">
                                            <span>
                                                <i class="icon-leaf"></i>GC188-250153(待批准)
                                            </span></a>
                                    </li>
                                    
                                    <li>
                                        <a onclick="ShowReport('/FileUpload/report/PDF/2285855.pdf?1399',this)" style="cursor: pointer; text-decoration: none;" data-id="2285855" data-sampleid="1505871" data-value="GC188-250154">
                                            <span>
                                                <i class="icon-leaf"></i>GC188-250154(待批准)
                                            </span></a>
                                    </li>
                                    
                                    <li>
                                        <a onclick="ShowReport('/FileUpload/report/PDF/2285857.pdf?1399',this)" style="cursor: pointer; text-decoration: none;" data-id="2285857" data-sampleid="1505872" data-value="GC188-250155">
                                            <span>
                                                <i class="icon-leaf"></i>GC188-250155(待批准)
                                            </span></a>
                                    </li>
                                    
                                    <li>
                                        <a onclick="ShowReport('/FileUpload/report/PDF/2285858.pdf?1399',this)" style="cursor: pointer; text-decoration: none;" data-id="2285858" data-sampleid="1505873" data-value="GC188-250156">
                                            <span>
                                                <i class="icon-leaf"></i>GC188-250156(待批准)
                                            </span></a>
                                    </li>
                                    
                                    <li>
                                        <a onclick="ShowReport('/FileUpload/report/PDF/2285861.pdf?1399',this)" style="cursor: pointer; text-decoration: none;" data-id="2285861" data-sampleid="1505874" data-value="GC188-250157">
                                            <span>
                                                <i class="icon-leaf"></i>GC188-250157(待批准)
                                            </span></a>
                                    </li>
                                    
                                </ul>
                            </li>
                            <li>
                                <a style="cursor: pointer; text-decoration: none;" onclick="ShowAuditList('GC18-250118')"><span><i class="icon-minus-sign"></i>变更历史记录</span></a>
                                <ul>
                                </ul>
                            </li>
                            <li>
                                <a style="cursor: pointer; text-decoration: none;" onclick="ShowCommunication('GC18-250118')"><span><i class="icon-minus-sign"></i>信息沟通</span></a> 
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <div style="width: 1%; height: 100%; float: left; margin-left: 5px;">
            <span>
                <a class="toggle-btn" id="nimei" style="height: 50px;" onclick="HSLeft()">
                    <i class="search-png" aria-hidden="true" title="查询"></i>
                </a>
            </span>
        </div>
        <div class="wrap">
            <div class="tittle" id="divbtn">
                <button type="button" class="btnN hidden" id="update" onclick="UpdateDay()">修改预计完成天数</button>
                <button type="button" class="btnN" id="text" onclick="BasisInfo()">标准文本</button>
                <button type="button" class="btnN" id="fee" style="display: none;" onclick="FeeJz()">校准费用</button>
                <button type="button" class="btnN" id="audit" onclick="ExaminationInfo()">审批情况</button>
                <button type="button" class="btnN" id="detail_fb" onclick="detail_fbInfo()" style="display: none;">报告详情</button>
                
                
            </div>
            
            <iframe class="J_iframe" name="iframe5" style="width: 100%; height: 100%; background-color: #fff;" frameborder="0" id="ibody"></iframe>

            <div id="HistoryInfo" style="display: none;">
                <div style="height: 100%; overflow-y: auto;">
                    <p style="margin: 5px 10px;"><b>检测报告编号：</b></p>
                    <table class="table table-bordered">
                    </table>
                </div>
            </div>
        </div>
    </form>
    <script type="text/javascript">
        var testingOrderNo = "";
        var testingOrderId = "";
        var testingReportId = "0", testingReportNo = "0";
        var sampleId = "0";
        $(function () {
            testingOrderNo = $("#hdtestingOrderNo").val();
            testingOrderId = $("#hdtestingOrderId").val();
            var height = $(window).height() - 130;  //取得iframe框架的实际宽度
            document.getElementById("ibody").style.height = height + "px";
            $('.tree li:has(ul)').addClass('parent_li').find(' > span').attr('title', 'Collapse this branch');
            $('.tree li.parent_li > span').on('click', function (e) {
                var children = $(this).parent('li.parent_li').find(' > ul > li');
                if (children.is(":visible")) {
                    children.hide('fast');
                    $(this).attr('title', 'Expand this branch').find(' > i').addClass('icon-plus-sign').removeClass('icon-minus-sign');
                } else {
                    children.show('fast');
                    $(this).attr('title', 'Collapse this branch').find(' > i').addClass('icon-minus-sign').removeClass('icon-plus-sign');
                }
                e.stopPropagation();
            });
            ShowOrder($("#hdtestingOrderId").val());
            //$('.progress .progress-bar').progressbar({ display_text: 'fill' });
            //判断是否是工程以及检验以及评估咨询，是的话不要显示样品信息
            if ("收样" == "工程" || "收样" == "检验" || "收样" == "评估咨询") {
                $("#GcJyLi").hide();
            }
        });

        //跳转到任务查询页面的
        function hrefView() {
            var url = "../IntegratedQueryManage/taskQuery.aspx?testingOrderId=" + GetQueryString("testingOrderId");
            $("#ibody").attr("src", url);
            var height = $(window).height() - 130;  //取得iframe框架的实际宽度
            document.getElementById("ibody").style.height = height + "px";
            $("#audit").hide();
            $("#update").hide();
            $("#end").hide();
            $("#text").hide();
            $("#fee").hide();
            $("#change").hide();
            $("#detail_fb").hide();
        }
        function ShowReport(url, obj) {
            testingReportId = $(obj).attr("data-id");
            testingReportNo = $(obj).attr("data-value");
            sampleId = $(obj).attr("data-sampleid");
            // var index2 = layer.load(0, { shade: false });
            var index = layer.load(1, {
                shade: [0.3, '#000'] //0.1透明度的白色背景
            });
            $("#detail_fb").hide();
            if (url.indexOf(".aspx") > 0) {
                $("#ibody").attr("src", url);
                var height = $(window).height() - 130;  //取得iframe框架的实际宽度
                var width = $(window).width() - 300;
                document.getElementById("ibody").style.height = height + "px";
                $("#audit").show();
                $("#text").hide();
            } else if (url == "00.htm") {
                SearchPDF(testingReportId);
                $("#audit").show();
                $("#text").hide();
                $("#detail_fb").show();
            } else if (url.indexOf(".html") > 0) {
                $("#ibody").attr("src", url);
                $("#audit").hide();
                $("#text").show();//2020-4-20原始委托界面按钮显示有误,进行修改
            } else {
                var json = {
                    method: "CopyPDF", reportId: testingReportId, v: '1'
                }
                ajax(json, replacePDF, "report/testingReportQuery.ashx", "json");
                layer.closeAll('loading');
                $("#ibody").load(function () {
                    layer.closeAll('loading');
                });
                $("#audit").show();
                $("#text").hide();
            }
            //else {
            //    layer.closeAll('loading');
            //    layer.alert("报告无链接,或者未生成PDF文件");
            //}
            // $("#audit").show(); 
            $("#update").hide();
            $("#end").hide();
            //$("#text").hide();
            $("#fee").hide();
            $("#change").hide();
        }
        //查找PDF路径
        function SearchPDF(id) {
            var json = {
                method: "SearchPDF", reportId: id
            }
            ajax(json, SearchData, "report/testingReportQuery.ashx", "json");
        }
        function SearchData(data) {
            layer.closeAll('loading');
            if (data.state == "1") {
                if (data.url != "") {
                    $("#ibody").attr("src", "../../Common/JS/pdfjs/web/viewer.html?file=" + data.url + "?" + Math.random());
                } else {
                    $("#ibody").attr("src", "/ui/404.html?" + Math.random());
                }
            } else {
                layer.alert(data.msg);
            }
        }


        function replacePDF(data) {
            layer.closeAll('loading');
            if (data.state == "1") {
                $("#ibody").attr("src", "../../Common/JS/pdfjs/web/viewer.html?file=/FileUpload/report/PDF/" + testingReportId + ".pdf?" + Math.random());
            } else if (data.state == "3") { //调用盖章的文件
                $("#ibody").attr("src", "../../Common/JS/pdfjs/web/viewer.html?file=" + data.url + "?" + Math.random());
            } else {
                layer.alert(data.msg);
            }
            var height = $(window).height() - 130;  //取得iframe框架的实际宽度
            var width = $(window).width() - 300;
            document.getElementById("ibody").style.height = height + "px";
        }
        var index = 0;
        function UpdateDay() {
            //页面层
            index = layer.open({
                type: 1,
                title: '修改预计完成天数',
                skin: 'layui-layer-rim', //加上边框
                area: ['80%', '80%'], //宽高
                content: '<div style="margin-top:20px;">' +
                    '<label style="width:30%;float:left;text-align:center;">预计天数：</label>' +
                    '<div style="float:left;width:60%;">' +
                '<input type="text" class="col-xs-12 form-control" id="day" value="11" />' +
                    '</div><div style="text-align: center; float: left; width: 100%;">' +
                    '<button type="button" class="btn btn-primary" id="submit" onclick="submitDay()">确定</button>' +
                    '</div>' +
                    '</div>'
            });
        }

        function BasisInfo() {
            layer.open({
                type: 2,
                title: '标准文本',
                skin: 'layui-layer-rim', //加上边框
                area: ['80%', '80%'], //宽高
                content: ["BasisList.aspx?testingOrderId=" + testingOrderId]
            });
        }
        function FeeJz() {
            layer.open({
                type: 2,
                title: '校准费用',
                skin: 'layui-layer-rim', //加上边框
                area: ['80%', '80%'], //宽高
                content: ["../report/reportFee_jz.aspx?testingOrderId=" + testingOrderId]
            });
        }

        function OrderEnd() {
            layer.open({
                type: 2,
                title: '委托终止',
                skin: 'layui-layer-rim', //加上边框
                area: ['820px', '80%'], //宽高
                content: ["TestingOrderEnd.aspx?testingOrderId=" + testingOrderId],
                end: function () {
                    window.history.go(0);
                }
            });
        }

        function ShowAuditList(order) {
            var url = "../IntegratedQueryManage/AuditList.html?testingOrderId=" + testingOrderId;
            $("#ibody").attr("src", url);
            $("#audit").hide();
            $("#update").hide();
            $("#end").hide();
            $("#text").hide();
            $("#fee").hide();
            $("#change").hide();
            $("#detail_fb").hide();
        }

        function ShowCommunication(order) {
            var url = "../IntegratedQueryManage/CommunicationList.html?testingOrderId=" + testingOrderId;
            $("#ibody").attr("src", url);
            $("#audit").hide();
            $("#update").hide();
            $("#end").hide();
            $("#text").hide();
            $("#fee").hide();
            $("#change").hide();
            $("#detail_fb").hide();
        }

        function submitDay() {
            //alert($("#day").val() + '===' + GetQueryString("testingOrderNo"))
            var json = {
                method: "UpdateDay", day: $("#day").val(), testingOrderNo: testingOrderNo
            };
            var oa = updateSucess;
            try {
                ajax(json, oa, "IntegratedQueryManage/IntegratedQuery.ashx", "json");
            }
            catch (e) {

                layer.msg(e.message, { time: 2000 });
            }
            cancel();
        }
        function updateSucess(data) {

            layer.closeAll('loading');
            if (data.state == "1") {
                cancel();
                window.parent.layer.msg(data.msg)
            }
            else
                layer.msg(data.msg)

        }



        function cancel() {
            layer.close(index);
        }
        function ShowSamples(id) {
            var url = "../TestingOrder/SamplesDetail.html?sampleid=" + id;
            $("#ibody").attr("src", url);
            var height = $(window).height() - 130;  //取得iframe框架的实际宽度
            document.getElementById("ibody").style.height = height + "px";
            $("#audit").hide();
            $("#update").hide();
            $("#end").hide();
            $("#text").hide();
            $("#fee").hide();
            $("#change").hide();
            $("#detail_fb").hide();
        }
        function ShowOrder(orderId) {
            var url = "../TestingOrder/PrintTestingOrderReplace.aspx?testingOrderId=" + orderId;
            $("#ibody").attr("src", url);
            var height = $(window).height() - 130;  //取得iframe框架的实际宽度
            document.getElementById("ibody").style.height = height + "px";
            $("#audit").hide();
            $("#update").show();
            $("#end").show();
            $("#text").show();
            if ("收样" == "校准")
                $("#fee").show();
            $("#change").show();
            $("#detail_fb").hide();
        }
        function OrderChange(flg) {
            var testingOrderId = GetQueryString("testingOrderId");
            var url = "";
            if (flg == 0) {
                url = "OrderChangeNoReport.aspx?testingOrderNo=" + testingOrderNo + "&testingOrderId=" + testingOrderId;
                layer.open({
                    type: 2,
                    title: '委托变更',
                    skin: 'layui-layer-rim', //加上边框
                    area: ['520px', '80%'], //宽高
                    content: url,
                    end: function () {
                        //window.history.go(0);
                    }
                });
            } else {
                url = "OrderChangeHasReport.aspx?testingOrderNo=" + testingOrderNo + "&testingOrderId=" + testingOrderId;
                layer.open({
                    type: 2,
                    title: '委托变更',
                    skin: 'layui-layer-rim', //加上边框
                    area: ['520px', '80%'], //宽高
                    content: url,
                    end: function () {
                        //var src=$("#hdSrc").val();
                        //window.history.go(0);
                        //$("#ibody").attr("src", src);
                    }
                });
            }

        }
        var HSFlg = true;
        function HSLeft() {
            if (HSFlg) {
                $("#menuLeft").hide();
                $(".wrap").removeClass("two");
                $(".wrap").addClass("one", "98%;")
                HSFlg = false;
            } else {
                $("#menuLeft").show();
                $(".wrap").removeClass("one");
                $(".wrap").addClass("two", "74%;")
                HSFlg = true;
            }
        }
        function ExaminationInfo() {
            layer.open({
                title: "检测报告审批情况",
                type: 2,
                area: ['70%', '70%'],
                content: "auditInfo.aspx?testingReportId=" + testingReportId
            })
            //var json_data = { method: "testingReportHistoryInfo", testingReportId: testingReportId };
            //var handle = HistoryInfo;
            //try {
            //    ajax(json_data, handle, "/IntegratedQueryManage/IntegratedQuery.ashx", "json");
            //}
            //catch (e) { 
            //    layer.msg(e.message, { time: 2000 });
            //}
        }
        function detail_fbInfo() {
            layer.open({
                title: "上传报告详情",
                type: 2,
                area: ['70%', '70%'],
                fix: true, //固定
                maxmin: false,
                content: "../report/WaitBuild.aspx?testingReportId=" + testingReportId + "&sampleId=" + sampleId
            })
        }
        $(function () {
            $("#ibody").load(function () {
                layer.closeAll('loading');
            });
            $("#audit").hide();
        })

        function HistoryInfo(data) {
            layer.closeAll('loading');
            if (data.length > 0) {
                var html_table = "<tr><th style='width:5%;'>序号</th><th style='width:30%;'>复核情况</th><th style='width:30%;'>审核情况</th><th style='width:30%;'>批准情况</th></tr>";
                var index = 1;
                var index_num = 0;
                var right = false;
                for (var i = 0; i < data.length; i++) {
                    right = false;
                    var auditStatus = data[i].auditStatus;
                    if ((index_num % 3 == 0) || index_num == 0) {
                        html_table += "<tr><td>" + index + "</td>";
                        index++;
                    }
                    if (index_num % 3 == 0) {
                        if (auditStatus == 2) {
                            html_table += "<td>意见：" + data[i].auditResult + "<br/>";
                            html_table += "原因：" + data[i].auditRemark + "<br/>";
                            html_table += "时间：" + data[i].createTime + "<br/>";
                            html_table += "复核人：" + data[i].auditUserName + "</td>";
                        } else {
                            right = true;
                            html_table += "<td></td>";
                        }
                    } else if (index_num % 3 == 1) {
                        if (auditStatus == 3) {
                            html_table += "<td>意见：" + data[i].auditResult + "<br/>";
                            html_table += "原因：" + data[i].auditRemark + "<br/>";
                            html_table += "时间：" + data[i].createTime + "<br/>";
                            html_table += "审核人：" + data[i].auditUserName + "</td>";
                        } else {
                            right = true;
                            html_table += "<td></td>";
                        }
                    } else if (index_num % 3 == 2) {
                        if (auditStatus == 9 || auditStatus == 4) {
                            html_table += "<td>意见：" + data[i].auditResult + "<br/>";
                            html_table += "原因：" + data[i].auditRemark + "<br/>";
                            html_table += "时间：" + data[i].createTime + "<br/>";
                            html_table += "批准人：" + data[i].auditUserName + "</td>";
                        } else {
                            right = true;
                            html_table += "<td></td>";
                        }
                    }
                    if ((index_num + 1) % 3 == 0) {
                        html_table += "</tr>";
                    }
                    index_num++;
                    if (right) {
                        i--;
                        continue;
                    }
                    if (i + 1 == data.length && index_num % 3 > 0) {
                        var num = 3 - index_num % 3;
                        for (var j = 0; j < num; j++) {
                            html_table += "<td></td>";
                        }
                        html_table += "</tr>";
                    }
                }
                $("#HistoryInfo p>b").text("检测报告编号：" + testingReportNo);
                $("#HistoryInfo table").html(html_table);
                layer.open({
                    title: "检测报告审批情况",
                    type: 1,
                    area: ['70%', '70%'],
                    fix: true, //固定
                    maxmin: false,
                    content: $("#HistoryInfo").html()
                })
            }
            else {
                layer.alert("抱歉，没有查到相关数据！");
            }
        }
    </script>
</body>
</html>
