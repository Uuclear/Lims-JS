


<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
	非标报告查看
</title><link rel="stylesheet" type="text/css" href="../../Common/Css/bootstrap/bootstrap.min.css" />
    <script src="../../Common/JS/jquery.js"></script>
    <script src="../../Common/JS/bootstrap.js"></script>
    <script src="../../Common/layui/layui.all.js"></script>
    <script src="../../Common/JS/handle.js"></script>
    <script src="../../Common/layui/xm-select.js"></script> 
    <style type="text/css">
        .form-inline .form-control.col-xs-12 { width: 100%; }

        .form-inline .form-control.col-xs-8 { width: 66.6%; }

        .form-inline .form-group .col-xs-2 { padding: 0px 5px; }

        .table > thead > tr > th, .table > thead > tr > td, .table > tbody > tr > th, .table > tbody > tr > td, .table > tfoot > tr > th, .table > tfoot > tr > td { line-height: 30px; }

        .butdiv { position: absolute; left: 35%; top: 60%; width: 79px; height: 26px; }

        .div_group { display: inline-block; vertical-align: middle; width: 100%; float: left; margin-right: 20px; margin-top: 10px; }

        .div_group_type { width: 49%; float: left; margin: 0px 10px; }
        .div_group_type2 { width: 32%; float: left; }

        .col-sm-4 .form-control { width: 190px; }

        .file-drop-zone-title { padding: 10%; }

        .file-input { width: 100%; }
        /*.f2, .f1 { display: none; }*/
    </style>
</head>
<body>
    <form method="post" action="./WaitBuild.aspx?testingReportId=1535332&amp;sampleId=1381259" id="form1">
<div class="aspNetHidden">
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwUKMTUzNDE0MDU4OA8WAh4TVmFsaWRhdGVSZXF1ZXN0TW9kZQIBFgICAw9kFgICAQ8QDxYGHg5EYXRhVmFsdWVGaWVsZAUIcGFydENvZGUeDURhdGFUZXh0RmllbGQFCHBhcnROYW1lHgtfIURhdGFCb3VuZGdkEBUBEOWFrOi3r+e7hCDkuLvkvZMVAQRTMTI1FCsDAWdkZGRfJCiieN1BraZuoYWWHwAz0IMh0IXUL5X34gezVInW2A==" />
</div>

<div class="aspNetHidden">

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="1041A209" />
	<input type="hidden" name="__EVENTVALIDATION" id="__EVENTVALIDATION" value="/wEdAAKJKHSl61k6nFenmN2DvDZS+cgIK+5EClWnb6w+om0IE1OOzRTinW5TCNG2tKBzK5fb3R3FoIlYmtATLYOJRyRH" />
</div>
        <div style="width: 80%; margin: 10px auto;">
            <div class="panel panel-default">
                <div class="panel-heading">报告基本信息</div>
                <div class="panel-body">
                    <div class="div_group">
                        <div class="div_group_type2">
                            <label class="col-sm-5 control-label">报告编号</label>
                            <div class="col-sm-7">
                                <input class="form-control" id="testingReportCode" disabled="disabled" type="text" placeholder="" />
                            </div>
                        </div>
                        <div class="div_group_type2">
                            <label class="col-sm-5 control-label">委托编号</label>
                            <div class="col-sm-7">
                                <input class="form-control" id="testingOrderCode" disabled="disabled" type="text" placeholder="" value="" />
                            </div>
                        </div>
                        <div class="div_group_type2">
                            <label class="col-sm-5 control-label">样品编号</label>
                            <div class="col-sm-7">
                                <input class="form-control" id="sampleNo" disabled="disabled" type="text" placeholder="" value="" />
                            </div>
                        </div>
                    </div>
                    <div class="div_group">
                        <div class="div_group_type2">
                            <label class="col-sm-5 control-label">实验开始日期</label>
                            <div class="col-sm-7">
                                <input class="form-control" type="text" id="testStartDate" disabled="disabled" autocomplete="off" />
                            </div>
                        </div>
                        <div class="div_group_type2">
                            <label class="col-sm-5 control-label">实验结束日期</label>
                            <div class="col-sm-7">
                                <input class="form-control" type="text" id="testEndDate" disabled="disabled" autocomplete="off" />
                            </div>
                        </div>
                        <div class="div_group_type2">
                            <label class="col-sm-5 control-label">报告结论性质</label>
                            <div class="col-sm-7">
                                <select id="reportResultProperty" class="form-control" disabled="disabled">
                                    <option value="合格">合格</option>
                                    <option value="不合格">不合格</option>
                                    <option value="--" selected="selected">--</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="div_group">
                        <label class="col-sm-3 control-label">上传报告附件类型</label>
                        <div class="col-sm-9">
                            <input type="radio" name="fb" value="线下" disabled="disabled" />
                            已审批（上传已签发报告PDF扫描件，不需要再进行网上审批）<br />
                            <input type="radio" name="fb" value="线上" disabled="disabled" />
                            未审批（上传未签发报告原件，需要进行网上同步审批）<br />
                            <input type="radio" name="fb" value="线上签名" onchange="selectType()" disabled="disabled" />
                            <span>未审批（上传未签发报告PDF文件，进行网上审批）</span>
                        </div>
                    </div>

                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">其它信息</div>
                <div class="panel-body">
                    <div class="div_group" id="html_dep">
                        <!--这个不能删，留着遍历用-->
                        <label class="col-sm-5 control-label" style="display: none;">检验部门</label>
                        <div class="col-sm-4" style="display: none;">
                            <select name="ddl_dep" id="ddl_dep" class="col-xs-12 form-control" style="width: 250px; padding: 6px 12px!important;">
	<option value="S125">公路组 主体</option>

</select>
                        </div>
                    </div>
                    <div class="div_group">
                        <div class="div_group_type2">
                            <label class="col-sm-5 control-label">编制人</label>
                            <div class="col-sm-7">
                                <div id="bianzhiName"></div>
                            </div>
                        </div>
                        <div class="div_group_type2 f2">
                            <label class="col-sm-5 control-label">审核人</label>
                            <div class="col-sm-7">
                                <div id="shenheName"></div>
                            </div>
                        </div>
                        <div class="div_group_type2 f2">
                            <label class="col-sm-5 control-label">批准人</label>
                            <div class="col-sm-7">
                                <div id="pizhunName"></div>
                            </div>
                        </div>
                    </div>
                    <div class="div_group">
                        <div class="div_group_type2">
                            <label class="col-sm-5 control-label">提交日期</label>
                            <div class="col-sm-7">
                                <input class="form-control" type="text" id="submitTime" disabled="disabled" />
                            </div>
                        </div>
                        <div class="div_group_type2 f2">
                            <label class="col-sm-5 control-label">审核日期</label>
                            <div class="col-sm-7">
                                <input class="form-control" type="text" id="approvedDate" disabled="disabled" />
                            </div>
                        </div>
                        <div class="div_group_type2 f2">
                            <label class="col-sm-5 control-label">签发日期</label>
                            <div class="col-sm-7">
                                <input class="form-control" type="text" id="approvedDateII" disabled="disabled" />
                            </div>
                        </div>
                        <div class="div_group">
                            <div class="div_group_type f3">
                                <label class="col-sm-4 control-label" style="width: 26.66%">标识章</label>
                                <div class="col-sm-8" style="line-height: 35px;" id="div_seal">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel-heading">附件信息</div>
                <div class="panel-body" id="">
                    <div style="width: 100%;" id="historyAtta"></div>
                </div>
            </div>
        </div>
    </form>
    <script type="text/javascript">
        $(function () {
            deptBind();
            getBianZhiRen();
            getShenHeRen();
            getPiZhunRen(); 
            SetInfo();
        })
        function selectType() {
            var type = $("input[type='radio'][name='fb']:checked").val();
            //if (type == "线上") {
            //    $(".f1").show();
            //    $(".f2").hide();
            //} else if (type == "线下") {
            //    $(".f1").hide();
            //    $(".f2").show();
            //}
        }
        var sampleId = GetQueryString("sampleId");

        var userDemo0;
        function getBianZhiRen() {
            var json_data = { method: "getBianZhiRen", sampleId: sampleId };
            var handle = getBianZhiRenData;
            ajax2(json_data, handle, "../../AjaxRequest/ReportDesign/report.ashx", "json");
        }
        function getBianZhiRenData(data) {
            layer.closeAll('loading');
            userDemo0 = xmSelect.render({
                el: '#bianzhiName',
                tips: '编制人',
                disabled: true,
                prop: {
                    name: 'Name',
                    value: 'Name',
                },
                data: data
            })
        }
        function getShenHeRen() {
            var json_data = { method: "getShenHeRen", sampleId: sampleId };
            var handle = getShenHeRenData;
            ajax2(json_data, handle, "ReportDesign/report.ashx", "json");
        }
        var userDemo1;
        function getShenHeRenData(data) {
            layer.closeAll('loading');
            userDemo1 = xmSelect.render({
                el: '#shenheName',
                tips: '审核人',
                disabled: true,
                prop: {
                    name: 'Name',
                    value: 'Id',
                },
                autoRow: true,
                data: data
            })
        }

        function getPiZhunRen() {
            var json_data = { method: "getPiZhunRen", sampleId: sampleId };
            var handle = getPiZhunRenData;
            ajax2(json_data, handle, "ReportDesign/report.ashx", "json");
        }
        var userDemo2;
        function getPiZhunRenData(data) {
            layer.closeAll('loading');
            userDemo2 = xmSelect.render({
                el: '#pizhunName',
                tips: '批准人',
                disabled: true,
                prop: {
                    name: 'Name',
                    value: 'Id',
                },
                autoRow: true,
                data: data
            })

        }

        String.prototype.format = function () {
            var str = this.toString();
            if (!arguments.length)
                return str;
            var args = typeof arguments[0],
                args = (("string" == args || "number" == args) ? arguments : arguments[0]);
            for (arg in args)
                str = str.replace(RegExp("\\{" + arg + "\\}", "gi"), args[arg]);
            return str;
        }

        function deptBind() {
            var url = "basicInfo/Dictionary.ashx";
            var json_data = { method: "GetParameterField" };
            ajax2(json_data, setFieldType, url, "json");
        }

        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return decodeURI(r[2]);
            return null;
        }
        var testingOrderId = 0;
        function getSeal() {
            var url = "../../AjaxRequest/Seal/seal_base.ashx";
            var json_data = { method: "GetSealOrderId", testingOrderId: testingOrderId };
            ajax2(json_data, getSealData, url, "json");
        }
        function getSealData(res) {
            layer.closeAll('loading');
            var html = "";
            if (res.length > 0) {
                for (var i = 0; i < res.length; i++) {
                    html += '<input type="checkbox" data-id="' + res[i].sealId + '" value="' + res[i].sealName + '" data-src="' + res[i].sealUrl + '" disabled="disabled" /> ' + res[i].sealName;
                }
            }
            $("#div_seal").html(html);
        }
        var demo1, demo2, demo3, demo4, demo5, demo6, demo7;
        function setFieldType(res) {
            layer.closeAll('loading');
            var html = '<div class="div_group"> ';
            html += '       <div class="div_group_type2">';
            html += '           <label class="col-sm-5 control-label">{0}</label>';
            html += '               <div class="col-sm-7">';
            html += '                   <input class="col-xs-6 form-control" type="text" id="{1}" value="{2}" data-code="{3}" disabled="disabled" />';
            html += '               </div>';
            html += '       </div>';
            html += '       <div class="div_group_type2 f1" style="width:66%">';
            html += '           <label class="col-sm-5 control-label" style="width:20.2%">领域信息 </label>';
            html += '           <div class="col-sm-7" style="width:77%">';
            html += '               <div id="{4}"></div>';
            html += '           </div>';
            html += '       </div>';
            html += '</div>';


            var dep = $("#ddl_dep option");
            for (var i = 0; i < dep.length; i++) {
                var html_dep = "";
                var value = dep.eq(i).val();
                var name = dep.eq(i).text();
                var arr = name.split(' ');
                if (arr[1] == "主体") {
                    html_dep = html.format(["主体部门", "zhuti", arr[0], value, "zhuti_lingyu"]);
                } else {
                    html_dep = html.format(["副体部门", "futi" + i, arr[0], value, "futi_lingyu" + i]);
                }
                $("#html_dep").append(html_dep);
                switch (i) {
                    case 0:
                        demo1 = xmSelect.render({
                            el: '#zhuti_lingyu',
                            tips: '主体领域',
                            autoRow: true,
                            disabled: true,
                            data: res
                        })
                        break;
                    case 1:
                        demo2 = xmSelect.render({
                            el: '#futi_lingyu' + i,
                            tips: '副体领域',
                            autoRow: true,
                            disabled: true,
                            data: res
                        })
                        break;
                    case 2:
                        demo3 = xmSelect.render({
                            el: '#futi_lingyu' + i,
                            tips: '副体领域',
                            autoRow: true,
                            disabled: true,
                            data: res
                        })
                        break;
                    case 3:
                        demo4 = xmSelect.render({
                            el: '#futi_lingyu' + i,
                            tips: '副体领域',
                            autoRow: true,
                            disabled: true,
                            data: res
                        })
                        break;
                    case 4:
                        demo5 = xmSelect.render({
                            el: '#futi_lingyu' + i,
                            tips: '副体领域',
                            autoRow: true,
                            data: res
                        })
                        break;
                    case 5:
                        demo6 = xmSelect.render({
                            el: '#futi_lingyu' + i,
                            tips: '副体领域',
                            autoRow: true,
                            disabled: true,
                            data: res
                        })
                        break;
                    case 6:
                        demo7 = xmSelect.render({
                            el: '#futi_lingyu' + i,
                            tips: '副体领域',
                            autoRow: true,
                            data: res
                        })
                        break;
                }
            }
        }

        function SetInfo() {
            var testingReportId = GetQueryString("testingReportId");
            var json_data = { method: "GetReportInfo_fb", testingReportId: testingReportId };
            var handle = ReportInfoData;
            ajax2(json_data, handle, "../../AjaxRequest/ReportDesign/report.ashx", "json");
        }
        function ReportInfoData(res) {
            layer.closeAll("loading");
            if (res.state = "1") {
                var data = res.data1[0];
                $("#testingReportCode").val(data.testingReportCode + data.isStarFlag);
                $("#sampleNo").val(data.sampleNo);
                $("#testingOrderCode").val(data.testingOrderCode);
                $("#testStartDate").val(FormatTime(data.testStartDate));
                $("#testEndDate").val(FormatTime(data.testEndDate));
                $("#reportResultProperty").val(data.reportResultProperty);
                if (data.reportUrl != "" && data.reportUrl != undefined) { 
                    if (data.standBy1 == "线上签名") {
                        //报告打印显示盖章版本，综合查询和任务管理显示未盖章版本  
                        SearchPDF(data.testingReportId);
                    }
                    else {
                        var url = "../.." + data.reportUrl.replace("~", "");
                        $("#historyAtta").html('<a href="' + url + '" target="_blank">附件下载</a>');
                    }  
                } else {
                    $("#historyAtta").html("<span style=\"margin-left:10px;\">无附件</span>");
                }
                $("input[type='radio'][name='fb']:checked").prop("checked", false);
                $("input[type='radio'][name='fb']").each(function () {
                    var value = $(this).val();
                    if (data.standBy1 == value) {
                        $(this).prop("checked", true);
                        selectType();
                    }
                })
                userDemo0.setValue([data.submitter.trim()]);
                //if (data.standBy1 == "线上签名") {
                //    userDemo0.setValue([data.reviewName.trim()]);
                //}
                $("#approvedDate").val(FormatTime(data.approvedDate));
                $("#approvedDateII").val(FormatTime(data.approvedDateII));
                var user1 = [], user2 = [];
                if (data.approvedId) {
                    var arr1 = data.approvedId.split(',');
                    var arr2 = data.approvedIdII.split(',');
                    for (var i = 0; i < arr1.length; i++) {
                        if (arr1[i] != "")
                            user1.push(arr1[i]);
                    }
                    for (var i = 0; i < arr2.length; i++) {
                        if (arr2[i] != "")
                            user2.push(arr2[i]);
                    }
                    userDemo1.setValue(user1);
                    userDemo2.setValue(user2);
                }
                $("#submitTime").val(FormatTime(data.submitTime));
                if (data.standBy1 == "线上" || data.standBy1 == "线上签名") { 
                    testingOrderId = data.testingOrderId;
                    getSeal();
                    SetSeal();
                    getReportFieldData(res.data2);
                }
            }
        }
        //查找PDF路径
        function SearchPDF(id) {
            var json = {
                method: "SearchPDF", reportId: id
            }
            ajax(json, SearchData, "report/testingReportQuery.ashx", "json");
        }
        function SearchData(data) {
            layer.closeAll('loading');
            if (data.state == "1") {
                if (data.url != "") {
                    var url = "../../Common/JS/pdfjs/web/viewer.html?file=" + data.url + "?" + Math.random();
                    $("#historyAtta").html('<a href="' + url + '" target="_blank">附件下载</a>'); 
                } else {
                    $("#historyAtta").html("<span style=\"margin-left:10px;\">无附件</span>");
                }
            } else {
                layer.alert(data.msg);
            }
        }
        function SetSeal() {
            var testingReportId = GetQueryString("testingReportId");
            var url = "../../AjaxRequest/Task/NonStandard.ashx";
            var json_data = { method: "GetReportSeal", testingReportId: testingReportId };
            ajax2(json_data, SetSealData, url, "json");
        }
        function SetSealData(res) {
            layer.closeAll('loading');
            if (res.length > 0) {
                for (var i = 0; i < res.length; i++) {
                    $("#div_seal input").each(function () {
                        var sealId = $(this).data("id");
                        if (sealId == res[i].sealId) {
                            $(this).prop("checked", true);
                        }
                    })
                }
            }
        }
        function getReportFieldData(data) {
            if (data.length > 0) {
                var obj = $("input[id^=futi]");
                var arr1 = [], arr2 = [], arr3 = [], arr4 = [], arr5 = [], arr6 = [], arr7 = [];
                for (var i = 0; i < obj.length; i++) {
                    var code = obj.eq(i).data("code");
                    for (var j = 0; j < data.length; j++) {
                        var deptCode = data[j].code;
                        if (deptCode == code) {
                            switch (i) {   //从副体算起，所以 从demo2  起
                                case 0:
                                    arr2.push(data[j].arr);
                                    break;
                                case 1:
                                    arr3.push(data[j].arr);
                                    break;
                                case 2:
                                    arr4.push(data[j].arr);
                                    break;
                                case 3:
                                    arr5.push(data[j].arr);
                                    break;
                                case 4:
                                    arr6.push(data[j].arr);
                                    break;
                                case 5:
                                    arr7.push(data[j].arr);
                                    break;
                            }
                            data.splice(j, 1);
                            j = -1;
                        }
                    }
                }
                var zhuti = $("#zhuti").data("code");
                for (var i = 0; i < data.length; i++) {
                    var deptCode = data[i].code;
                    if (deptCode == zhuti) {
                        arr1.push(data[i].arr);
                        data.splice(i, 1);
                        i = -1;
                    }
                }
                if (arr1.length > 0)
                    demo1.setValue(arr1);
                if (arr2.length > 0)
                    demo2.setValue(arr2);
                if (arr3.length > 0)
                    demo3.setValue(arr3);
                if (arr4.length > 0)
                    demo4.setValue(arr4);
                if (arr5.length > 0)
                    demo5.setValue(arr5);
                if (arr6.length > 0)
                    demo6.setValue(arr6);
                if (arr7.length > 0)
                    demo7.setValue(arr7);
            }
        }
    </script>
</body>
</html>
